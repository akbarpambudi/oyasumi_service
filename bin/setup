#!/bin/bash

# Exit on error
set -e

echo "ðŸš€ Starting Good Night development environment setup..."

# Check for required dependencies
echo "ðŸ” Checking dependencies..."
command -v docker >/dev/null 2>&1 || { echo "âŒ Docker is required but not installed. Please install Docker first."; exit 1; }
command -v docker-compose >/dev/null 2>&1 || { echo "âŒ Docker Compose is required but not installed. Please install Docker Compose first."; exit 1; }
command -v ruby >/dev/null 2>&1 || { echo "âŒ Ruby is required but not installed. Please install Ruby first."; exit 1; }
command -v bundle >/dev/null 2>&1 || { echo "âŒ Bundler is required but not installed. Please install Bundler first."; exit 1; }

# Start PostgreSQL and Redis containers
echo "ðŸ³ Starting PostgreSQL and Redis containers..."
docker-compose up -d postgres redis

# Wait for PostgreSQL to be ready
echo "â³ Waiting for PostgreSQL to be ready..."
until docker-compose exec postgres pg_isready -h localhost -p 5432 -U postgres; do
  echo "â³ Waiting for PostgreSQL..."
  sleep 2
done

# Install Ruby dependencies
echo "ðŸ“¦ Installing Ruby dependencies..."
bundle install

# Setup database
echo "ðŸ’¾ Setting up database..."
bundle exec rails db:create db:migrate

# Setup test database
echo "ðŸ§ª Setting up test database..."
bundle exec rails db:test:prepare

# Create .env file if it doesn't exist
if [ ! -f .env ]; then
  echo "ðŸ“ Creating .env file..."
  cat > .env << EOL
DATABASE_URL=postgres://postgres:postgres@localhost:5432/good_night_development
REDIS_URL=redis://localhost:6379/0
JWT_SECRET_KEY=$(openssl rand -hex 32)
EOL
fi

echo "âœ… Setup completed successfully!"
echo "ðŸ“ Please check .env file for configuration"
echo "ðŸš€ Start the server with: bundle exec rails server"
echo "ðŸ§ª Run tests with: bundle exec rspec"
